package SQL;


import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.sql.*;

public class StaffForm extends JFrame {
    private JTextField txtMa, txtTen, txtChucVu, txtSDT;
    private JTable table;
    private DefaultTableModel model;

    public StaffForm() {
        setTitle("Quản lý nhân viên");
        setSize(900, 520);
        setLocationRelativeTo(null);
        setLayout(new BorderLayout());
        setDefaultCloseOperation(DISPOSE_ON_CLOSE);

        JLabel header = new JLabel("QUẢN LÝ NHÂN VIÊN", JLabel.CENTER);
        header.setOpaque(true);
        header.setBackground(new Color(0, 102, 204));
        header.setForeground(Color.WHITE);
        header.setFont(new Font("Segoe UI", Font.BOLD, 22));
        add(header, BorderLayout.NORTH);

        JPanel main = new JPanel(new GridLayout(1, 2));
        add(main, BorderLayout.CENTER);

        JPanel left = new JPanel(new GridLayout(10, 1, 6, 6));
        left.setBorder(BorderFactory.createEmptyBorder(18, 18, 18, 18));
        left.setBackground(new Color(240, 244, 247));

        left.add(new JLabel("Mã nhân viên:"));
        txtMa = new JTextField();
        left.add(txtMa);

        left.add(new JLabel("Họ tên:"));
        txtTen = new JTextField();
        left.add(txtTen);

        left.add(new JLabel("Chức vụ:"));
        txtChucVu = new JTextField();
        left.add(txtChucVu);

        left.add(new JLabel("Số điện thoại:"));
        txtSDT = new JTextField();
        left.add(txtSDT);

        main.add(left);

        model = new DefaultTableModel();
        model.setColumnIdentifiers(new String[]{"Mã NV", "Họ tên", "Chức vụ", "SĐT"});
        table = new JTable(model);
        JScrollPane scroll = new JScrollPane(table);
        main.add(scroll);

        table.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent e) {
                int i = table.getSelectedRow();
                if (i >= 0) {
                    txtMa.setText(String.valueOf(model.getValueAt(i, 0)));
                    txtTen.setText(String.valueOf(model.getValueAt(i, 1)));
                    txtChucVu.setText(String.valueOf(model.getValueAt(i, 2)));
                    txtSDT.setText(String.valueOf(model.getValueAt(i, 3)));
                }
            }
        });

        JPanel bottom = new JPanel();
        JButton btnAdd = new JButton("Thêm");
        JButton btnUpdate = new JButton("Sửa");
        JButton btnDelete = new JButton("Xóa");
        JButton btnRefresh = new JButton("Làm mới");

        btnAdd.addActionListener(e -> addStaff());
        btnUpdate.addActionListener(e -> updateStaff());
        btnDelete.addActionListener(e -> deleteStaff());
        btnRefresh.addActionListener(e -> loadData());

        bottom.add(btnAdd);
        bottom.add(btnUpdate);
        bottom.add(btnDelete);
        bottom.add(btnRefresh);

        add(bottom, BorderLayout.SOUTH);

        loadData();
    }

    private void loadData() {
        model.setRowCount(0);
        try (Connection conn = MySQLConnection.getConnection();
             PreparedStatement ps = conn.prepareStatement("SELECT ma_nhan_vien, ho_ten, chuc_vu, so_dien_thoai FROM nhanvien");
             ResultSet rs = ps.executeQuery()) {

            while (rs.next()) {
                model.addRow(new Object[]{
                        rs.getString("ma_nhan_vien"),
                        rs.getString("ho_ten"),
                        rs.getString("chuc_vu"),
                        rs.getString("so_dien_thoai")
                });
            }
        } catch (Exception ex) {
            ex.printStackTrace();
            JOptionPane.showMessageDialog(this, "Lỗi load nhân viên: " + ex.getMessage());
        }
    }

    private void addStaff() {
        String ma = txtMa.getText().trim();
        if (ma.isEmpty() || txtTen.getText().trim().isEmpty()) {
            JOptionPane.showMessageDialog(this, "Mã nhân viên và Họ tên là bắt buộc.");
            return;
        }

        try (Connection conn = MySQLConnection.getConnection();
             PreparedStatement ps = conn.prepareStatement(
                     "INSERT INTO nhanvien (ma_nhan_vien, ho_ten, chuc_vu, so_dien_thoai) VALUES (?,?,?,?)")) {

            ps.setString(1, ma);
            ps.setString(2, txtTen.getText().trim());
            ps.setString(3, txtChucVu.getText().trim());
            ps.setString(4, txtSDT.getText().trim());

            ps.executeUpdate();
            JOptionPane.showMessageDialog(this, "Thêm nhân viên thành công.");
            loadData();
        } catch (Exception ex) {
            ex.printStackTrace();
            JOptionPane.showMessageDialog(this, "Lỗi thêm nhân viên: " + ex.getMessage());
        }
    }

    private void updateStaff() {
        String ma = txtMa.getText().trim();
        if (ma.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Nhập mã nhân viên để cập nhật.");
            return;
        }

        try (Connection conn = MySQLConnection.getConnection();
             PreparedStatement ps = conn.prepareStatement(
                     "UPDATE nhanvien SET ho_ten=?, chuc_vu=?, so_dien_thoai=? WHERE ma_nhan_vien=?")) {

            ps.setString(1, txtTen.getText().trim());
            ps.setString(2, txtChucVu.getText().trim());
            ps.setString(3, txtSDT.getText().trim());
            ps.setString(4, ma);

            int r = ps.executeUpdate();
            if (r > 0) {
                JOptionPane.showMessageDialog(this, "Cập nhật thành công.");
                loadData();
            } else {
                JOptionPane.showMessageDialog(this, "Mã nhân viên không tồn tại.");
            }
        } catch (Exception ex) {
            ex.printStackTrace();
            JOptionPane.showMessageDialog(this, "Lỗi cập nhật: " + ex.getMessage());
        }
    }

    private void deleteStaff() {
        String ma = txtMa.getText().trim();
        if (ma.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Nhập mã nhân viên để xóa.");
            return;
        }

        try (Connection conn = MySQLConnection.getConnection();
             PreparedStatement ps = conn.prepareStatement("DELETE FROM nhanvien WHERE ma_nhan_vien=?")) {

            ps.setString(1, ma);
            int r = ps.executeUpdate();
            if (r > 0) {
                JOptionPane.showMessageDialog(this, "Xóa thành công.");
                loadData();
            } else {
                JOptionPane.showMessageDialog(this, "Mã nhân viên không tồn tại.");
            }
        } catch (Exception ex) {
            ex.printStackTrace();
            JOptionPane.showMessageDialog(this, "Lỗi xóa: " + ex.getMessage());
        }
    }
}
